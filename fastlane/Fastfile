fastlane_version "2.102.0"

default_platform :ios

platform :android do
  before_all do
    apk = "FeedTheMonster.apk"

    ENV["FL_HOCKEY_APK"] = apk
	ENV["FL_HOCKEY_API_TOKEN"] = "834d997e517543058d09e13402fc5410"

	ENV["FL_SLACK_CHANNEL"] = "#build"
    ENV["SLACK_URL"] = "https://hooks.slack.com/services/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"

    ENV["SUPPLY_APK"] = apk
  end

  desc "Deploy Feed the Monster Live to alpha track on Google Play"

  lane :beta do
    hockey(
      public_identifier:"10d447ce2a1b40cc80a17676187e73e0",
      timeout: 3600,
      bypass_cdn: true
    )

    supply(
	  apk: "FeedTheMonster.apk",
      json_key: "/Users/administrator/fastlane_feedthemonster_upload_key.json",
      package_name: "com.eduapp4syria.feedthemonster",
      track: "alpha"
    )

    slack(
      message: "Deployed Feed the Monster Google Live to alpha track on Google Play.",
      success: true
    )
  end

  error do |lane, exception|
    slack(
      channel: "#build",
      message: exception.message,
      success: false
    )
  end  
end

platform :ios do
  before_all do
    project_file = 
    workspace_file = 
    user_name = "eduapp4syria@gmail.com" 

    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "5"
  
	ENV["FL_HOCKEY_API_TOKEN"] = "dfc2a768618e417787cfcc7be7a631bd"

    ENV["GYM_WORKSPACE"] = 'FeedTheMonster_iOS/Unity-iPhone.xcworkspace'

    ENV["PILOT_USERNAME"] = user_name

	export FASTLANE_SESSION='---\n- !ruby/object:HTTP::Cookie\n  name: DES513240128702baf723206455de643e380\n  value: HSARMTKNSRVTWFlaQRuLJjaPzLoW468o/gYS7FCUMZrG/PClPrCP9cubJlwTSKISpcCHVG/URZgKBVNYpa5MGALP/1tgdH1utZjpICEs/1iwCm1k7RyUhayVSeA4y5mn/0KbKeU=SRVT\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires: \n  max_age: 2592000\n  created_at: &1 2018-11-28 19:53:52.144690000 +00:00\n  accessed_at: *1\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiItNlJNYUNqM0NzTXFVckQ2Z2ZpRTdBIn0.p4QU1B54kSe7mbdRUjZb7ibuwAAJp0ea2H-J2l2_PWw\n  domain: olympus.itunes.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires: \n  max_age: 1800\n  created_at: &2 2018-11-28 19:53:53.088190000 +00:00\n  accessed_at: *2\n'

	ENV["FASTLANE_USER"] = user_name
	ENV["FASTLANE_PASSWORD"] = "Gaziantep671"

	get_certificates           
	get_provisioning_profile(app_identifier: "com.worktile.lesschat")

	ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "nlfv-xjkt-zwde-dcnr"

    ENV["FL_SLACK_CHANNEL"] = "#build"
	ENV["SLACK_URL"] = "https://hooks.slack.com/services/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"
  end

  desc "Update certificates"
  lane :certificates do
    match(
      type: "development"
    )
  end

  desc "Deploy Feed the Monster Google Live to TestFlight and HockeyApp"

  lane :beta do

    get_certificates           # invokes cert
	get_provisioning_profile   # invokes sigh

    #match(
    #  type: "appstore"
    #)

    # https://docs.fastlane.tools/codesigning/xcode-project/#xcode-9-and-up

    gym(
      export_method: "app-store"
    )

    hockey(
      public_identifier:"2c76e9aae9774eedb14827e43428f744",
      timeout: 3600,
      bypass_cdn: true
    ) 
    
    pilot(
      ipa: "FeedTheMonster.ipa",
      wait_for_uploaded_build: true
    )

    slack(
      message: "Deployed Feed the Monster iOS Live to beta test on TestFlight.",
      success: true
    )    
  end
end
